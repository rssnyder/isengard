apiVersion: v1
kind: Namespace
metadata:
  name: garage

---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: garage-rpc-secret
  namespace: garage
spec:
  encryptedData:
    rpc-secret: AgBk6V9cv20G2TIsfLxwhPWLjaUxUubn4P8q7I77vDCtFWUcpyQZ0IzuKFAOLWijaXGk/yllFQv4nU1QCInbNBCmIugPve6Y9tqjJ+/HmwbJutfxaUiFaiTerAOAswpLBKTVpbYWgdxHbgRIZWX40cYIRPKW+OFL6r/N1S4CF13PhzdL9CJkF6ZvTXYxz6MPYHKCheNiOuBmV03B5V9rAMKIi+EKV7PJ3NW2UJIrNMQeGTMiBNoNCS8XRZCIPylzoGBBZePxWCfZkBSQ6p8r31YYiuZ5va8hRNqP/cJEbzWWDyZZwQEZZRlDD09CdPZYuq/pN5hufNP9NzBepCjNapv4toQCNmIlraNm/UgmYIYSrMGPUstw1Xxk2eu9zHkW6/JHq2Td/iJaAaXaPl36C8vLoN2k7dw9nK0nlI7an2Bm6MMf/1Gqrg2MT9S+RMZ//DHHSFlUTuQmU6X+6ZvBpOWT2JG1t+m3Ypbe4J9J5d2cgDdOC4v60pb0hLQwRsJB44fsdcEvs5B/jfjcTjIMM/zt+z+xErx/xNICUqH3dQY7WA7BNJwp4yrvkNUfWsYwpjTvxZy//9flRhyrK63S0gFSndkDaQUFA1sreB+RBb4zp5IlCBSflTlq9T8iuMOnw/10iZn9cEn6N9IBxZ1m83R/GvbizoF6EY+Snt0vUz/nhEhWgAiJ3ZWksTUFQxvIVp638f2uJC+lPZghSFKVJZabAL6Ob2AvGb+mmSwwoIi4DIM5cFkJPdRFSSN6T/BMwrDb0pL5DZeByqPQibrFQ8RE
  template:
    metadata:
      name: garage-rpc-secret
      namespace: garage

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: garage-config
  namespace: garage
data:
  garage.toml: |
    metadata_dir = "/data/meta"
    data_dir = "/data/data"
    
    replication_mode = "none"
    
    rpc_bind_addr = "[::]:3901"
    rpc_public_addr = "[::]:3901"
    rpc_secret = "${GARAGE_RPC_SECRET}"
    
    [s3_api]
    s3_region = "garage"
    api_bind_addr = "[::]:3900"
    root_domain = ".s3.g3.r.ss"
    
    [s3_web]
    bind_addr = "[::]:3902"
    root_domain = ".web.g3.r.ss"
    
    [admin]
    api_bind_addr = "[::]:3903"

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: garage
  namespace: garage
spec:
  serviceName: garage
  replicas: 1
  selector:
    matchLabels:
      app: garage
  template:
    metadata:
      labels:
        app: garage
    spec:
      initContainers:
      - name: config-init
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache gettext
          export GARAGE_RPC_SECRET=$(cat /secrets/rpc-secret)
          envsubst < /config-template/garage.toml > /config/garage.toml
          echo "Config generated with RPC secret"
        volumeMounts:
        - name: garage-config-template
          mountPath: /config-template
        - name: garage-config-rendered
          mountPath: /config
        - name: garage-rpc-secret
          mountPath: /secrets
      containers:
      - name: garage
        image: dxflrs/garage:v1.0.1
        imagePullPolicy: IfNotPresent
        command: ["/garage", "-c", "/config/garage.toml", "server"]
        ports:
        - name: s3-api
          containerPort: 3900
        - name: rpc
          containerPort: 3901
        - name: web
          containerPort: 3902
        - name: admin
          containerPort: 3903
        volumeMounts:
        - name: garage-data
          mountPath: /data
        - name: garage-config-rendered
          mountPath: /config
        env:
        - name: RUST_LOG
          value: "garage=info"
      volumes:
      - name: garage-config-template
        configMap:
          name: garage-config
      - name: garage-config-rendered
        emptyDir: {}
      - name: garage-rpc-secret
        secret:
          secretName: garage-rpc-secret
  volumeClaimTemplates:
  - metadata:
      name: garage-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 50Gi

---
apiVersion: v1
kind: Service
metadata:
  name: garage-s3
  namespace: garage
spec:
  type: LoadBalancer
  selector:
    app: garage
  ports:
  - name: s3-api
    port: 3900
    targetPort: s3-api
  - name: admin
    port: 3903
    targetPort: admin

---
apiVersion: v1
kind: Service
metadata:
  name: garage-rpc
  namespace: garage
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    app: garage
  ports:
  - name: rpc
    port: 3901
    targetPort: rpc
